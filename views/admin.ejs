<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ø³ÙˆØ¨Ø§Ø±</title>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/admin.css">
  <style>
    body {
      font-family: "Vazirmatn", sans-serif;
      margin: 0;
      background: #f9f9f9;
    }
    .admin-header {
      background: #2b3a55;
      color: white;
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .admin-wrapper {
      display: flex;
      min-height: 100vh;
    }
    .sidebar {
      width: 220px;
      background: #eee;
      padding: 1rem;
    }
    .sidebar ul {
      list-style: none;
      padding: 0;
    }
    .sidebar li {
      padding: 10px;
      cursor: pointer;
      border-radius: 8px;
      margin-bottom: 5px;
      transition: 0.3s;
    }
    .sidebar li.active,
    .sidebar li:hover {
      background: #d4d4d4;
      font-weight: 600;
    }
    .content {
      flex: 1;
      padding: 2rem;
    }
    .form-card {
      background: white;
      padding: 1.5rem;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      display: none; /* Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ù¾Ù†Ù‡Ø§Ù† */
    }
    .form-card.active {
      display: block;
    }
    .form-group {
      margin-bottom: 1rem;
    }
    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
    }
    .btn-primary {
      background: #2b3a55;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    .btn-primary:hover {
      background: #3b4a6b;
    }
    .brand-card:hover {
      transform:scale(1.06);
      box-shadow:0 4px 12px rgba(0,0,0,0.18);
    }
    .modal-box {
      animation: pop 0.25s ease;
    }
    @keyframes pop {
      from { transform:scale(0.8); opacity:0; }
      to { transform:scale(1); opacity:1; }
    }
    .product-card {
      background:white;
      padding:10px;
      border-radius:12px;
      box-shadow:0 2px 5px rgba(0,0,0,0.1);
      width:160px;
      cursor:pointer;
      transition:0.3s;
      text-align:center;
    }
    .product-card:hover {
      transform: scale(1.06);
      box-shadow: 0 4px 12px rgba(0,0,0,0.18);
    }

  </style>
</head>
<body>

  <header class="admin-header">
    <h1>ğŸ› ï¸ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ø³ÙˆØ¨Ø§Ø±</h1>
    <div class="admin-user">
      <span>Ù…Ø¯ÛŒØ±</span>
      <a href="/logout" class="logout-btn" style="color:white;">Ø®Ø±ÙˆØ¬</a>
    </div>
  </header>

  <main class="admin-wrapper">
    <aside class="sidebar">
      <ul>
        <li class="menu-item active" data-target="add-brand">ğŸ“¦ Ø§ÙØ²ÙˆØ¯Ù† Ø¨Ø±Ù†Ø¯</li>
        <li class="menu-item" data-target="add-product">ğŸ›’ Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø­ØµÙˆÙ„</li>
      </ul>
    </aside>
    
      <% if (typeof q != 'undefined') { %>
        <div class="error-msg"><%= q %></div>
      <% } %>


    <section class="content">
      <!-- ÙØ±Ù… Ø§ÙØ²ÙˆØ¯Ù† Ø¨Ø±Ù†Ø¯ -->
      <div class="form-card active" id="add-brand">
        <h2>â• Ø§ÙØ²ÙˆØ¯Ù† Ø¨Ø±Ù†Ø¯ Ø¬Ø¯ÛŒØ¯</h2>
        <form action="/admin/add-brand" method="POST" enctype="multipart/form-data">
          <div class="form-group">
            <label>Ù†Ø§Ù… Ø¨Ø±Ù†Ø¯:</label>
            <input type="text" name="brand_name" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ù¾Ø§Ø±Ø³ Ø§Ø´Ù†" required>
          </div>
          <div class="form-group">
            <label>Ù„ÙˆÚ¯Ùˆ Ø¨Ø±Ù†Ø¯:</label>
            <input type="file" name="logo" id="brand-logo" accept="image/*">
            <% if (brands.length > 0 && brands[0].logo_path) { %>
              <img id="brand-logo-preview" src="<%= brands[0].logo_path %>" alt="Ù„ÙˆÚ¯Ùˆ Ø¨Ø±Ù†Ø¯" style="margin-top:10px; max-width:150px; border-radius:8px;">
            <% } else { %>
              <img id="brand-logo-preview" src="#" alt="Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ Ù„ÙˆÚ¯Ùˆ Ø¨Ø±Ù†Ø¯" style="display:none; margin-top:10px; max-width:150px; border-radius:8px;">
            <% } %>
          </div>
          <button type="submit" class="btn-primary">Ø«Ø¨Øª Ø¨Ø±Ù†Ø¯</button>
        </form>

        <hr style="margin: 2rem 0;">

        <h3>ğŸ“‹ Ù„ÛŒØ³Øª Ø¨Ø±Ù†Ø¯Ù‡Ø§ÛŒ Ø«Ø¨Øªâ€ŒØ´Ø¯Ù‡</h3>
        <div class="brand-list" style="display:flex; flex-wrap:wrap; gap:20px; margin-top:10px;">
          <% if (brands && brands.length > 0) { %>
            <% brands.forEach(brand => { %>
              <div class="brand-card" data-id="<%= brand.brand_id %>" style="background:white; padding:10px; border-radius:12px; box-shadow:0 2px 5px rgba(0,0,0,0.1); width:160px; text-align:center; cursor:pointer; transition:0.3s;">
                <img src="<%= brand.logo ? brand.logo : '/images/no-image.png' %>" alt="<%= brand.brand_name %>" style="width:100px; height:100px; object-fit:cover; border-radius:8px; transition:0.3s;">
                <p style="margin-top:8px; font-weight:600;"><%= brand.brand_name %></p>
                <p style="margin-top:8px; font-weight:600;"><%= brand.updatedAt %></p>
              </div>
            <% }) %>
          <% } else { %>
            <p>Ù‡ÛŒÚ† Ø¨Ø±Ù†Ø¯ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>
          <% } %>
        </div>
        
        <div id="brand-edit-modal" class="modal-overlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:none; justify-content:center; align-items:center; z-index:1000;">
          <div class="modal-box" style="background:white; padding:20px; border-radius:15px; width:350px; box-shadow:0 4px 15px rgba(0,0,0,0.2); animation:pop 0.25s ease;">
            <h3 style="margin-top:0; text-align:center;">ÙˆÛŒØ±Ø§ÛŒØ´ Ø¨Ø±Ù†Ø¯</h3>
            <form id="edit-brand-form" action="/admin/edit-brand" method="POST" enctype="multipart/form-data">
              <input type="hidden" name="brand_id" id="edit-brand-id">

              <label>Ù†Ø§Ù… Ø¨Ø±Ù†Ø¯:</label>
              <input type="text" name="brand_name" id="edit-brand-name" style="width:100%; margin-bottom:10px; padding:8px; border-radius:8px; border:1px solid #ccc;">

              <label>Ù„ÙˆÚ¯Ùˆ Ø¬Ø¯ÛŒØ¯:</label>
              <input type="file" name="logo" id="edit-brand-logo" accept="image/*" style="margin-bottom:10px;">

              <img id="edit-brand-preview" src="#" style="width:120px; height:120px; object-fit:cover; border-radius:10px; display:none; margin:auto;">

              <button type="submit" style="margin-top:15px; width:100%; background:#2b3a55; color:white; padding:10px; border:none; border-radius:10px; cursor:pointer;">Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª</button>
            </form>

            <button id="close-modal" style="margin-top:10px; width:100%; background:#888; color:white; padding:10px; border:none; border-radius:10px; cursor:pointer;">Ø¨Ø³ØªÙ†</button>
          </div>
        </div>

      </div>

      <!-- ÙØ±Ù… Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø­ØµÙˆÙ„ -->
      <div class="form-card" id="add-product">
        <h2>â• Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø­ØµÙˆÙ„ Ø¬Ø¯ÛŒØ¯</h2>
        <form action="/admin/add-product" method="POST" enctype="multipart/form-data">
          <div class="form-group">
            <label>Ù†Ø§Ù… Ù…Ø­ØµÙˆÙ„:</label>
            <input type="text" name="p_name" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ø³ÛŒÙ„Ø±" required>
          </div>
          <div class="form-group">
            <label>Ø§Ù†ØªØ®Ø§Ø¨ Ø¨Ø±Ù†Ø¯:</label>
            <select name="b_id" required>
              <option value="" selected>-- Ø§Ù†ØªØ®Ø§Ø¨ Ø¨Ø±Ù†Ø¯ --</option>
              <% brands.forEach(function(b) { %>
                <option value="<%= b.brand_id %>"><%= b.brand_name %></option>
              <% }) %>
            </select>
          </div>
          <div class="form-group">
            <label>Ø¹Ú©Ø³ Ù…Ø­ØµÙˆÙ„:</label>
            <input type="file" name="p_logo" id="product-logo" accept="image/*">
            <% if (products.length > 0 && products[0].product_logo) { %>
              <img id="product-logo-preview" src="<%= products[0].product_logo %>" alt="Ø¹Ú©Ø³ Ù…Ø­ØµÙˆÙ„" style="margin-top:10px; max-width:150px; border-radius:8px;">
            <% } else { %>
              <img id="product-logo-preview" src="#" alt="Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ Ø¹Ú©Ø³ Ù…Ø­ØµÙˆÙ„" style="display:none; margin-top:10px; max-width:150px; border-radius:8px;">
            <% } %>
          </div>
          <div class="form-group">
            <label>Ù‚ÛŒÙ…Øª :</label>
            <input type="text" name="price" placeholder="0" required>
          </div>
          <button type="submit" class="btn-primary">Ø«Ø¨Øª Ù…Ø­ØµÙˆÙ„</button>
        </form>
        <hr style="margin: 2rem 0;">

        <h3>ğŸ›ï¸ Ù…Ø­ØµÙˆÙ„Ø§Øª</h3>
        <div id="product-list" style="display:flex; flex-wrap:wrap; gap:20px; margin-top:10px;">
          <p>Ù„Ø·ÙØ§Ù‹ Ø¨Ø±Ù†Ø¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ ØªØ§ Ù…Ø­ØµÙˆÙ„Ø§ØªØ´ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø´ÙˆØ¯.</p>
        </div>



            <!-- Ù¾Ø§Ù¾â€ŒØ¢Ù¾ Ø§Ø¯ÛŒØª Ù…Ø­ØµÙˆÙ„ -->
        <div id="product-edit-modal" class="modal-overlay" 
          style="position:fixed; top:0; left:0; width:100%; height:100%;
          background:rgba(0,0,0,0.5); display:none; justify-content:center;
          align-items:center; z-index:1000;">

          <div class="modal-box" 
            style="background:white; padding:20px; border-radius:15px;
            width:350px; box-shadow:0 4px 15px rgba(0,0,0,0.2);
            animation:pop 0.25s ease;">

            <h3 style="text-align:center; margin-top:0;">ÙˆÛŒØ±Ø§ÛŒØ´ Ù…Ø­ØµÙˆÙ„</h3>

            <form id="edit-product-form" action="/admin/edit-product" method="POST" enctype="multipart/form-data">
              <input type="hidden" name="p_id" id="edit-product-id">

              <label>Ù†Ø§Ù… Ù…Ø­ØµÙˆÙ„:</label>
              <input type="text" name="p_name" id="edit-product-name"
                style="width:100%; margin-bottom:10px; padding:8px; border-radius:8px; border:1px solid #ccc;">

              <label>Ù‚ÛŒÙ…Øª:</label>
              <input type="text" name="p_price" id="edit-product-price"
                style="width:100%; margin-bottom:10px; padding:8px; border-radius:8px; border:1px solid #ccc;">

              <label>Ø¹Ú©Ø³ Ø¬Ø¯ÛŒØ¯:</label>
              <input type="file" name="p_logo" id="edit-product-logo" accept="image/*">

              <img id="edit-product-preview" src="#"
                style="width:120px; height:120px; object-fit:cover; border-radius:10px;
                display:none; margin:auto; margin-top:12px;">

              <button type="submit"
                style="margin-top:15px; width:100%; background:#2b3a55; color:white;
                padding:10px; border:none; border-radius:10px; cursor:pointer;">
                Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª
              </button>
            </form>

            <button id="close-product-modal"
              style="margin-top:10px; width:100%; background:#888; color:white;
              padding:10px; border:none; border-radius:10px; cursor:pointer;">
              Ø¨Ø³ØªÙ†
            </button>
          </div>
        </div>

      </div>
    </section>
  </main>

  <script>
    const menuItems = document.querySelectorAll('.menu-item');
    const forms = document.querySelectorAll('.form-card');

    menuItems.forEach(item => {
      item.addEventListener('click', () => {
        menuItems.forEach(i => i.classList.remove('active'));
        item.classList.add('active');

        const target = item.getAttribute('data-target');
        forms.forEach(form => {
          if (form.id === target) {
            form.classList.add('active');
          } else {
            form.classList.remove('active');
          }
        });
      });
    });

    const brandLogoInput = document.getElementById('brand-logo');
    const brandPreview = document.getElementById('brand-logo-preview');

    brandLogoInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function (ev) {
          brandPreview.src = ev.target.result;
          brandPreview.style.display = 'block';
        };
        reader.readAsDataURL(file);
      } else {
        brandPreview.style.display = 'none';
      }
    });

    const productLogoInput = document.getElementById('product-logo');
    const productPreview = document.getElementById('product-logo-preview');
    if (productLogoInput) {
      productLogoInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = ev => {
            productPreview.src = ev.target.result;
            productPreview.style.display = 'block';
          };
          reader.readAsDataURL(file);
        } else {
          productPreview.style.display = 'none';
        }
      });
    };

    const brandSelect = document.querySelector('select[name="b_id"]');
    const productList = document.getElementById('product-list');

    brandSelect.addEventListener('change', async (e) => {
      const brandId = e.target.value;
      if (!brandId) {
        productList.innerHTML = "<p>Ù„Ø·ÙØ§Ù‹ Ø¨Ø±Ù†Ø¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.</p>";
        return;
      }

      try {
        const res = await fetch(`/api/products/${brandId}`);
        const products = await res.json();
        console.log(products);

        if (products.length === 0) {
          productList.innerHTML = "<p>Ù‡ÛŒÚ† Ù…Ø­ØµÙˆÙ„ÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ø¨Ø±Ù†Ø¯ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>";
          return;
        }
        

      productList.innerHTML = products.map(p => `
        <div class="product-card" data-id="${p.p_id}" 
          style="background:white; padding:10px; border-radius:12px; 
          box-shadow:0 2px 5px rgba(0,0,0,0.1); width:160px; cursor:pointer; 
          transition:0.3s; text-align:center;">

          <img src="${p.p_logo || '/images/no-image.png'}"
            alt="${p.p_name}" 
            style="width:100px; height:100px; object-fit:cover; border-radius:8px;">

          <p class="p-name" style="margin-top:8px; font-weight:600;">${p.p_name}</p>
          <p class="p-price" style="margin-top:5px;">${p.p_price}</p>
          <p style="margin-top:5px;">${p.updatedAt}</p>

        </div>
      `).join('');
      } catch (err) {
        console.error(err);
        productList.innerHTML = "<p>Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø­ØµÙˆÙ„Ø§Øª.</p>";
      }
    });

    // Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ù¾Ø§Ù¾â€ŒØ¢Ù¾ Ø¨Ø§ Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ Ù‡Ø± Ø¨Ø±Ù†Ø¯
    const brandCards = document.querySelectorAll('.brand-card');
    const modal = document.getElementById('brand-edit-modal');
    const closeModal = document.getElementById('close-modal');

    brandCards.forEach(card => {
      card.addEventListener('click', () => {
        const id = card.getAttribute('data-id');
        const name = card.querySelector('p').innerText;
        const img = card.querySelector('img').src;

        document.getElementById('edit-brand-id').value = id;
        document.getElementById('edit-brand-name').value = name;
        document.getElementById('edit-brand-preview').src = img;
        document.getElementById('edit-brand-preview').style.display = 'block';

        modal.style.display = 'flex';
      });
    });

    // Ø¨Ø³ØªÙ† Ù¾Ø§Ù¾â€ŒØ¢Ù¾
    closeModal.addEventListener('click', () => modal.style.display = 'none');

    modal.addEventListener('click', (e) => {
      if (e.target === modal) modal.style.display = 'none';
    });

    // Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ Ù„ÙˆÚ¯ÙˆÛŒ Ø¬Ø¯ÛŒØ¯ Ø¯Ø§Ø®Ù„ Ù¾Ø§Ù¾â€ŒØ¢Ù¾
    const logoInput = document.getElementById('edit-brand-logo');
    const preview = document.getElementById('edit-brand-preview');

    logoInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = ev => {
          preview.src = ev.target.result;
          preview.style.display = 'block';
        };
        reader.readAsDataURL(file);
      }
    });

    // --- Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ù¾Ø§Ù¾â€ŒØ¢Ù¾ Ø§Ø¯ÛŒØª Ù…Ø­ØµÙˆÙ„ ---
    document.addEventListener("click", function(e) {
      if (e.target.closest(".product-card")) {
        const card = e.target.closest(".product-card");


        const id = card.getAttribute("data-id");
        const name = card.querySelector(".p-name").innerText;
        const price = card.querySelector(".p-price").innerText;
        const img = card.querySelector("img").src;


        document.getElementById("edit-product-id").value = id;
        document.getElementById("edit-product-name").value = name;
        document.getElementById("edit-product-price").value = price;


        const preview = document.getElementById("edit-product-preview");
        preview.src = img;
        preview.style.display = "block";


        document.getElementById("product-edit-modal").style.display = "flex";
      }
    });


    // --- Ø¨Ø³ØªÙ† Ù¾Ø§Ù¾â€ŒØ¢Ù¾ ---
    document.getElementById("close-product-modal").addEventListener("click", () => {
    document.getElementById("product-edit-modal").style.display = "none";
    });


    document.getElementById("product-edit-modal").addEventListener("click", (e) => {
    if (e.target.id === "product-edit-modal") {
    e.target.style.display = "none";
    }
    });


    // --- Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ Ø¹Ú©Ø³ Ø¬Ø¯ÛŒØ¯ ---
    document.getElementById("edit-product-logo").addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (file) {
    const reader = new FileReader();
    reader.onload = ev => {
    document.getElementById("edit-product-preview").src = ev.target.result;
    document.getElementById("edit-product-preview").style.display = "block";
    };
    reader.readAsDataURL(file);
    }
    });

  </script>

</body>
</html>
